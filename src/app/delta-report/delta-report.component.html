<!-- Header -->
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-start flex-wrap my-3">
    <!-- LEFT: Logo + Title -->
    <div class="d-flex align-items-center mb-3 mb-sm-0">
      <img
        src="data:image/png;base64,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"
        alt="Company logo"
        class="me-2 header-logo"
      />
      <h2 class="mb-0">Vehicle Delta Report</h2>
    </div>
    <!-- RIGHT: stacked controls -->
    <div class="d-flex flex-column align-items-end" style="min-width: 320px; max-width: 560px;">
      <!-- Filter -->
      <input
        name="filter"
        type="text"
        class="form-control mb-2"
        style="min-width: 560px; height: 35px;"
        placeholder="Filter (year, make, model, action, quarter, date)â¦"
        [ngModel]="''"
        (ngModelChange)="onFilterChange($event)"
        autocomplete="off"
      />

      <!-- Quarter selector -->
      <ng-container *ngIf="quarters$ | async as quarters">
        <select
          id="quarterSelector"
          class="form-control"
          [disabled]="!quarters.length"
          [ngModel]="selectedQuarter"
          (ngModelChange)="fetchDeltaReport($event)"
        >
          <option disabled [ngValue]="undefined">Select Processing Quarter</option>
          <option *ngFor="let quarter of quarters" [ngValue]="quarter">{{ quarter }}</option>
        </select>
      </ng-container>

      <!-- Message -->
      <div *ngIf="selectedQuarter" class="mt-2 text-end small" aria-live="polite">
        <span class="fw-semibold">You are viewing Vehicle Changes Introduced in quarter â</span>
        {{ selectedQuarter }}
      </div>
    </div>
  </div>
</div>

<!-- Legend: right-aligned, separate row so it doesn't affect controls -->
<div class="mt-2 d-flex w-100 justify-content-end" role="note" aria-label="Vehicle state legend">
  <ul class="list-inline mb-0 small d-flex flex-wrap gap-3 justify-content-end text-end">
    <li class="list-inline-item">
      <span class="badge rounded-pill text-bg-secondary me-2">Baseline</span>
      <span class="text-muted">no changes</span>
    </li>
    <li class="list-inline-item">
      <span class="badge rounded-pill text-bg-success me-2">Added</span>
      <span class="text-muted">newly added</span>
    </li>
    <li class="list-inline-item">
      <span class="badge rounded-pill text-bg-danger me-2">Deleted</span>
      <span class="text-muted">removed this quarter</span>
    </li>
  </ul>
</div>

<table class="table table-bordered mt-4" *ngIf="filteredReport$ | async as report">
  <thead>
    <tr>
      <th>Id</th>
      <th>Year</th>
      <th>Make</th>
      <th>Model</th>
      <th>Published Date</th>
      <th>Processed Quarter</th>
      <th>Action State</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let row of report">
      <td>{{ row.serialNumber }}</td>
      <td>{{ row.year }}</td>
      <td>{{ row.make }}</td>
      <td>
        <a href class="link-primary text-decoration-underline" (click)="openCompareModal(row); $event.preventDefault()">
          {{ row.model }}
        </a>
      </td>
      <td>{{ row.publishedDate | date: 'MM/dd/yyyy':'':'en-US' }}</td>
      <td>{{ row.processedQuarter }}</td>
      <td>{{ row.actionState }}</td>
    </tr>
  </tbody>
</table>
<!-- Backdrop -->
<div *ngIf="showCompareModal" class="modal-backdrop fade show"></div>

<!-- Modal -->
<div *ngIf="showCompareModal" class="modal d-block" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="compareTitle">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="compareTitle" class="modal-title">Select the Quarters to compare articles</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeCompareModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Source quarter: all quarters -->
        <div class="mb-3">
          <label class="form-label">Source quarter</label>
          <select class="form-select" [ngModel]="sourceQuarterSel" (ngModelChange)="onSourceQuarterChange($event)">
            <option [ngValue]="undefined" disabled>Select a quarter</option>
            <option *ngFor="let q of allQuartersSorted" [ngValue]="q">{{ q }}</option>
          </select>
        </div>

        <!-- Target quarter: only neighbors of source -->
        <div class="mb-3">
          <label class="form-label">Target quarter</label>
          <select class="form-select" [disabled]="!adjacentOptions.length" [ngModel]="targetQuarterSel" (ngModelChange)="targetQuarterSel = $event">
            <option [ngValue]="undefined" disabled>Select adjacent quarter</option>
            <option *ngFor="let q of adjacentOptions" [ngValue]="q">{{ q }}</option>
          </select>
          <div class="form-text">Choose the previous or next quarter relative to the source.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeCompareModal()">Cancel</button>
        <button type="button" class="btn btn-primary" [disabled]="!targetQuarterSel" (click)="onCompareOk()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
